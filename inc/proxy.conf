access_by_lua_file '/etc/nginx/lua/dyups/access.lua';

header_filter_by_lua_block {
    if type(ngx.ctx.current) == "table" then
        local dyups = require("dyups.api")
        local address = ngx.ctx.current.address
        local port = ngx.ctx.current.port
        local target = address .. ":" .. port
        ngx.header["x-dyups-target"] = ngx.encode_base64(target)
    end
}

proxy_pass http://dyups;

proxy_set_header            Host 127.0.0.1;

proxy_http_version          1.1;

proxy_set_header            Connection "";
proxy_set_header            X-Real-IP $remote_addr;
proxy_set_header            X-Forwarded-For $proxy_add_x_forwarded_for;

# dyups headers
proxy_set_header            X-DYUPS true;
proxy_set_header            X-DYUPS-HOST $http_host;
proxy_set_header            X-DYUPS-SCHEMA $scheme;
proxy_set_header            X-DYUPS-IP $remote_addr;

proxy_redirect              off;

proxy_intercept_errors      on;

proxy_connect_timeout 10s;